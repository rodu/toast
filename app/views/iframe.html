<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Diplodoc Test Results Collection IFrame</title>
        <script src="/lib/jquery/dist/jquery.min.js"></script>
        <script src="/lib/platform/platform.js"></script>
    </head>
    <body>
        <div id="post-result"></div>
        <script>
            $(function(){
                var 
                    // Reads the origin parameter from the iframe generated
                    parentOrigin = "{{origin}}";
                    $postResults = $("#post-result"),
                    onEvent = window.addEventListener || window.attachEvent ||  function(){
                            console.error("Not support for standard event listeners... Come on...");
                        },
                    iframOrigin = window.location.protocol + "//" + window.location.host;
                onEvent("message", function(event){
                    var data = event.data;
                    if (parentOrigin !== event.origin){
                        console.error("Origin not allowed", event.origin);
                        return;
                    }
                    console.log("Got message from ", event.origin);
                    
                    // Adds client info gathered by the platform.js library,
                    // as expected by the DB schema to be saved
                    data.testruns.clientInfo = {
                        userAgent: platform.ua,
                        browserName: platform.name,
                        browserVersion: platform.version,
                        osArch: platform.os.architecture,
                        osFamily: platform.os.family,
                        osVersion: platform.os.version
                    };

                    $.ajax({
                        type: "POST",
                        url: "/api/testruns",
                        data: data.testruns,
                        dataType: "json"
                    
                    }).done(function(data){
                        window.parent.postMessage({
                            origin: iframOrigin,
                            success: true,
                            message: data.message
                        }, event.origin);

                    }).fail(function(jqXHR, textStatus){
                        window.parent.postMessage({
                            origin: iframOrigin,
                            message: textStatus
                        }, event.origin);
                    
                    });
                });
            });
        </script>
    </body>
</html>
